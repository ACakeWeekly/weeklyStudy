### tcpä¸‰æ¬¡æ¡æ‰‹åè®®

#### ä¸€ã€tcpé¦–éƒ¨

![tcpé¦–éƒ¨](../images/http/tcpå¤´éƒ¨.jpg)

æºç«¯å£å’Œç›®çš„ç«¯å£ï¼Œå„å 2ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«å†™å…¥æºç«¯å£å’Œç›®çš„ç«¯å£

åºå·ï¼Œå 4ä¸ªå­—èŠ‚ï¼ŒTCPè¿æ¥ä¸­ä¼ é€çš„å­—èŠ‚æµä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½æŒ‰é¡ºåºç¼–å·ã€‚ä¾‹å¦‚ï¼Œä¸€æ®µæŠ¥æ–‡çš„åºå·å­—æ®µå€¼æ˜¯ 301 ï¼Œè€Œæºå¸¦çš„æ•°æ®å…±æœ‰100å­—æ®µï¼Œæ˜¾ç„¶ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆå¦‚æœè¿˜æœ‰çš„è¯ï¼‰çš„æ•°æ®åºå·åº”è¯¥ä»401å¼€å§‹

ç¡®è®¤å·ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œæ˜¯æœŸæœ›æ”¶åˆ°å¯¹æ–¹ä¸‹ä¸€ä¸ªæŠ¥æ–‡çš„ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚çš„åºå·ã€‚ä¾‹å¦‚ï¼ŒBæ”¶åˆ°äº†Aå‘é€è¿‡æ¥çš„æŠ¥æ–‡ï¼Œå…¶åºåˆ—å·å­—æ®µæ˜¯501ï¼Œè€Œæ•°æ®é•¿åº¦æ˜¯200å­—èŠ‚ï¼Œè¿™è¡¨æ˜Bæ­£ç¡®çš„æ”¶åˆ°äº†Aå‘é€çš„åˆ°åºå·700ä¸ºæ­¢çš„æ•°æ®ã€‚å› æ­¤ï¼ŒBæœŸæœ›æ”¶åˆ°Açš„ä¸‹ä¸€ä¸ªæ•°æ®åºå·æ˜¯701ï¼Œäºæ˜¯Båœ¨å‘é€ç»™Açš„ç¡®è®¤æŠ¥æ–‡æ®µä¸­æŠŠç¡®è®¤å·ç½®ä¸º701

æ•°æ®åç§»ï¼Œå 4ä½ï¼Œå®ƒæŒ‡å‡ºTCPæŠ¥æ–‡çš„æ•°æ®è·ç¦»TCPæŠ¥æ–‡æ®µçš„èµ·å§‹å¤„æœ‰å¤šè¿œ

ä¿ç•™ï¼Œå 6ä½ï¼Œä¿ç•™ä»Šåä½¿ç”¨ï¼Œä½†ç›®å‰åº”éƒ½ä½0

ç´§æ€¥URGï¼Œå½“URG=1ï¼Œè¡¨æ˜ç´§æ€¥æŒ‡é’ˆå­—æ®µæœ‰æ•ˆã€‚å‘Šè¯‰ç³»ç»Ÿæ­¤æŠ¥æ–‡æ®µä¸­æœ‰ç´§æ€¥æ•°æ®

ç¡®è®¤ACKï¼Œä»…å½“ACK=1æ—¶ï¼Œç¡®è®¤å·å­—æ®µæ‰æœ‰æ•ˆã€‚TCPè§„å®šï¼Œåœ¨è¿æ¥å»ºç«‹åæ‰€æœ‰æŠ¥æ–‡çš„ä¼ è¾“éƒ½å¿…é¡»æŠŠACKç½®1

æ¨é€PSHï¼Œå½“ä¸¤ä¸ªåº”ç”¨è¿›ç¨‹è¿›è¡Œäº¤äº’å¼é€šä¿¡æ—¶ï¼Œæœ‰æ—¶åœ¨ä¸€ç«¯çš„åº”ç”¨è¿›ç¨‹å¸Œæœ›åœ¨é”®å…¥ä¸€ä¸ªå‘½ä»¤åç«‹å³å°±èƒ½æ”¶åˆ°å¯¹æ–¹çš„å“åº”ï¼Œè¿™æ—¶å€™å°±å°†PSH=1

å¤ä½RSTï¼Œå½“RST=1ï¼Œè¡¨æ˜TCPè¿æ¥ä¸­å‡ºç°ä¸¥é‡å·®é”™ï¼Œå¿…é¡»é‡Šæ”¾è¿æ¥ï¼Œç„¶åå†é‡æ–°å»ºç«‹è¿æ¥

åŒæ­¥SYNï¼Œåœ¨è¿æ¥å»ºç«‹æ—¶ç”¨æ¥åŒæ­¥åºå·ã€‚å½“SYN=1ï¼ŒACK=0ï¼Œè¡¨æ˜æ˜¯è¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼Œè‹¥åŒæ„è¿æ¥ï¼Œåˆ™å“åº”æŠ¥æ–‡ä¸­åº”è¯¥ä½¿SYN=1ï¼ŒACK=1

ç»ˆæ­¢FINï¼Œç”¨æ¥é‡Šæ”¾è¿æ¥ã€‚å½“FIN=1ï¼Œè¡¨æ˜æ­¤æŠ¥æ–‡çš„å‘é€æ–¹çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•ï¼Œå¹¶ä¸”è¦æ±‚é‡Šæ”¾

çª—å£ï¼Œå 2å­—èŠ‚ï¼ŒæŒ‡çš„æ˜¯é€šçŸ¥æ¥æ”¶æ–¹ï¼Œå‘é€æœ¬æŠ¥æ–‡ä½ éœ€è¦æœ‰å¤šå¤§çš„ç©ºé—´æ¥æ¥å—

æ£€éªŒå’Œï¼Œå 2å­—èŠ‚ï¼Œæ ¡éªŒé¦–éƒ¨å’Œæ•°æ®è¿™ä¸¤éƒ¨åˆ†

ç´§æ€¥æŒ‡é’ˆï¼Œå 2å­—èŠ‚ï¼ŒæŒ‡å‡ºæœ¬æŠ¥æ–‡æ®µä¸­çš„ç´§æ€¥æ•°æ®çš„å­—èŠ‚æ•°

é€‰é¡¹ï¼Œé•¿åº¦å¯å˜ï¼Œå®šä¹‰ä¸€äº›å…¶ä»–çš„å¯é€‰çš„å‚æ•°

#### äºŒã€çŠ¶æ€ç ç®€ä»‹

`LISTEN` - ä¾¦å¬æ¥è‡ªè¿œæ–¹TCPç«¯å£çš„è¿æ¥è¯·æ±‚ï¼›


`SYN-SENT` -åœ¨å‘é€è¿æ¥è¯·æ±‚åç­‰å¾…åŒ¹é…çš„è¿æ¥è¯·æ±‚ï¼›


`SYN-RECEIVED` - åœ¨æ”¶åˆ°å’Œå‘é€ä¸€ä¸ªè¿æ¥è¯·æ±‚åç­‰å¾…å¯¹è¿æ¥è¯·æ±‚çš„ç¡®è®¤ï¼›


`ESTABLISHED` - ä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„è¿æ¥ï¼Œæ•°æ®å¯ä»¥ä¼ é€ç»™ç”¨æˆ·ï¼›


`FIN-WAIT-1` - ç­‰å¾…è¿œç¨‹TCPçš„è¿æ¥ä¸­æ–­è¯·æ±‚ï¼Œæˆ–å…ˆå‰çš„è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›


`FIN-WAIT-2` - ä»è¿œç¨‹TCPç­‰å¾…è¿æ¥ä¸­æ–­è¯·æ±‚ï¼›


`CLOSE-WAIT` - ç­‰å¾…ä»æœ¬åœ°ç”¨æˆ·å‘æ¥çš„è¿æ¥ä¸­æ–­è¯·æ±‚ï¼›


`CLOSING` - ç­‰å¾…è¿œç¨‹TCPå¯¹è¿æ¥ä¸­æ–­çš„ç¡®è®¤ï¼›


`LAST-ACK` - ç­‰å¾…åŸæ¥å‘å‘è¿œç¨‹TCPçš„è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›


`TIME-WAIT` -ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´ä»¥ç¡®ä¿è¿œç¨‹TCPæ¥æ”¶åˆ°è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›


`CLOSED` - æ²¡æœ‰ä»»ä½•è¿æ¥çŠ¶æ€ï¼›

#### ä¸‰ã€tcpæ ‡å¿—ä½ --- ä½ç 

1. `SYN`(synchronous)ï¼šå»ºç«‹è”æœº
2. `ACK`(acknowledgement)ï¼šç¡®è®¤ 
3. `PSH`ï¼šDATAæ•°æ®ä¼ è¾“
4. `FIN`(finish)ï¼šç»“æŸ
5. `RST`(reset)ï¼šé‡ç½®
6. `URG`(urgent)ï¼šç´§æ€¥
7. `Sequence number`ï¼šé¡ºåºå·ç 
8. `Acknowledge number`ï¼šç¡®è®¤å·ç 

`ä½ç å‡ºç°çš„æƒ…å†µæ¦‚è¿°`

1. ACKæ˜¯å¯èƒ½ä¸SYNï¼ŒFINç­‰åŒæ—¶ä½¿ç”¨çš„ï¼Œæ¯”å¦‚SYNå’ŒACKå¯èƒ½åŒæ—¶ä¸º1ï¼Œå®ƒè¡¨ç¤ºçš„å°±æ˜¯å»ºç«‹è¿æ¥ä¹‹åçš„å“åº”ï¼Œ

2. SYNä¸FINæ˜¯ä¸ä¼šåŒæ—¶ä¸º1çš„ï¼Œå› ä¸ºå‰è€…è¡¨ç¤ºçš„æ˜¯å»ºç«‹è¿æ¥ï¼Œè€Œåè€…è¡¨ç¤ºçš„æ˜¯æ–­å¼€è¿æ¥ã€‚

3. RST(é‡ç½®)ä¸€èˆ¬æ˜¯åœ¨FIN(ç»“æŸè¿æ¥)ä¹‹åæ‰ä¼šå‡ºç°ä¸º1çš„æƒ…å†µï¼Œè¡¨ç¤ºçš„æ˜¯è¿æ¥é‡ç½®ã€‚

4. å‡ºç°FINåŒ…æˆ–RSTåŒ…æ—¶ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯æ–­å¼€äº†è¿æ¥

5. PSH(DATAæ•°æ®ä¼ è¾“) = 1çš„æƒ…å†µï¼Œä¸€èˆ¬åªå‡ºç°åœ¨DATAå†…å®¹ != 0çš„åŒ…ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´PSH = 1è¡¨ç¤ºçš„æ˜¯æœ‰çœŸæ­£çš„TCPæ•°æ®åŒ…å†…å®¹è¢«ä¼ é€’ã€‚

#### å››ã€æ¡æ‰‹è¿‡ç¨‹
![ä¸‰æ¬¡æ¡æ‰‹](../images/http/ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å›¾.jpg)

>æœ€å¼€å§‹çš„æ—¶å€™å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ˜¯å¤„äºCLOSEDçŠ¶æ€ã€‚ä¸»åŠ¨æ‰“å¼€è¿æ¥çš„ä¸ºå®¢æˆ·ç«¯ï¼Œè¢«åŠ¨æ‰“å¼€è¿æ¥çš„æ˜¯æœåŠ¡å™¨ã€‚

1. TCPæœåŠ¡å™¨è¿›ç¨‹å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œæ—¶åˆ»å‡†å¤‡æ¥å—å®¢æˆ·è¿›ç¨‹çš„è¿æ¥è¯·æ±‚ï¼Œæ­¤æ—¶æœåŠ¡å™¨å°±è¿›å…¥äº†LISTENï¼ˆç›‘å¬ï¼‰çŠ¶æ€

2. TCPå®¢æˆ·è¿›ç¨‹ä¹Ÿæ˜¯å…ˆåˆ›å»ºä¼ è¾“æ§åˆ¶å—TCBï¼Œå‘æœåŠ¡å™¨å‘å‡ºè¿æ¥è¯·æ±‚æŠ¥æ–‡ï¼Œè¿™æ—¶æŠ¥æ–‡é¦–éƒ¨ä¸­çš„åŒéƒ¨ä½SYN=1ï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸ªåˆå§‹åºåˆ—å· seq=x ï¼Œæ­¤æ—¶ï¼ŒTCPå®¢æˆ·ç«¯è¿›ç¨‹è¿›å…¥äº† SYN-SENTï¼ˆåŒæ­¥å·²å‘é€çŠ¶æ€ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒSYNæŠ¥æ–‡æ®µï¼ˆSYN=1çš„æŠ¥æ–‡æ®µï¼‰ä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†éœ€è¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·ã€‚

3. TCPæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æŠ¥æ–‡åï¼Œå¦‚æœåŒæ„è¿æ¥ï¼Œåˆ™å‘å‡ºç¡®è®¤æŠ¥æ–‡ã€‚ç¡®è®¤æŠ¥æ–‡ä¸­åº”è¯¥ ACK=1ï¼ŒSYN=1ï¼Œç¡®è®¤å·æ˜¯ack=x+1ï¼ŒåŒæ—¶ä¹Ÿè¦ä¸ºè‡ªå·±åˆå§‹åŒ–ä¸€ä¸ªåºåˆ—å· seq=yï¼Œæ­¤æ—¶ï¼ŒTCPæœåŠ¡å™¨è¿›ç¨‹è¿›å…¥äº†SYN-RCVDï¼ˆåŒæ­¥æ”¶åˆ°ï¼‰çŠ¶æ€ã€‚è¿™ä¸ªæŠ¥æ–‡ä¹Ÿä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†æ˜¯åŒæ ·è¦æ¶ˆè€—ä¸€ä¸ªåºå·ã€‚

4. TCPå®¢æˆ·è¿›ç¨‹æ”¶åˆ°ç¡®è®¤åï¼Œè¿˜è¦å‘æœåŠ¡å™¨ç»™å‡ºç¡®è®¤ã€‚ç¡®è®¤æŠ¥æ–‡çš„ACK=1ï¼Œack=y+1ï¼Œè‡ªå·±çš„åºåˆ—å·seq=x+1ï¼Œæ­¤æ—¶ï¼ŒTCPè¿æ¥å»ºç«‹ï¼Œå®¢æˆ·ç«¯è¿›å…¥ESTABLISHEDï¼ˆå·²å»ºç«‹è¿æ¥ï¼‰çŠ¶æ€ã€‚TCPè§„å®šï¼ŒACKæŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œä½†æ˜¯å¦‚æœä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚
å½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¡®è®¤åä¹Ÿè¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œæ­¤ååŒæ–¹å°±å¯ä»¥å¼€å§‹é€šä¿¡äº†

`é—®é¢˜1ï¼šä¸ºä»€ä¹ˆack = y + 1`

> æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„æ•°æ®è¿›è¡Œç¡®è®¤ï¼Œå› ä¸ºå·²ç»æ”¶åˆ°åºåˆ—å·ä¸ºyçš„æ•°æ®åŒ…ï¼Œå‡†å¤‡æ¥å—åºåˆ—å·ä¸ºy+1çš„æ•°æ®åŒ…ï¼Œæ‰€ä»¥ç¡®è®¤å·ack=y+1ã€‚

`é—®é¢˜2ï¼šä¸ºä»€ä¹ˆseq = x + 1`
> ACKæŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®ï¼Œå› æ­¤å¦‚æœä¸æºå¸¦æ•°æ®ï¼Œä¸æ¶ˆè€—åºåˆ—å·ï¼Œåˆ™ä¸‹ä¸€ä¸ªæŠ¥æ–‡çš„åºåˆ—å·ä»ç„¶æ˜¯seq=x+1ï¼›å¦‚æœæºå¸¦æ•°æ®ï¼Œåˆ™åºåˆ—å·ä¸ºåœ¨x+1çš„åŸºç¡€ä¸Šå¢åŠ æºå¸¦æ•°æ®çš„å¤§å°ã€‚æ­¤å¤„é»˜è®¤ç¬¬ä¸‰æ¬¡æ¡æ‰‹å®¢æˆ·ç«¯ä¸å‘é€æºå¸¦æ•°æ®çš„æŠ¥æ–‡æ®µ

`é—®é¢˜3ï¼š å¦‚æœå·²ç»å»ºç«‹äº†è¿æ¥ï¼Œä½†æ˜¯å®¢æˆ·ç«¯çªç„¶å‡ºç°æ•…éšœäº†æ€ä¹ˆåŠ`
>TCPè¿˜è®¾æœ‰ä¸€ä¸ªä¿æ´»è®¡æ—¶å™¨ï¼Œæ˜¾ç„¶ï¼Œå®¢æˆ·ç«¯å¦‚æœå‡ºç°æ•…éšœï¼ŒæœåŠ¡å™¨ä¸èƒ½ä¸€ç›´ç­‰ä¸‹å»ï¼Œç™½ç™½æµªè´¹èµ„æºã€‚æœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€æ¬¡å®¢æˆ·ç«¯çš„è¯·æ±‚åéƒ½ä¼šé‡æ–°å¤ä½è¿™ä¸ªè®¡æ—¶å™¨ï¼Œæ—¶é—´é€šå¸¸æ˜¯è®¾ç½®ä¸º2å°æ—¶ï¼Œè‹¥ä¸¤å°æ—¶è¿˜æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„ä»»ä½•æ•°æ®ï¼ŒæœåŠ¡å™¨å°±ä¼šå‘é€ä¸€ä¸ªæ¢æµ‹æŠ¥æ–‡æ®µï¼Œä»¥åæ¯éš”75ç§’é’Ÿå‘é€ä¸€æ¬¡ã€‚è‹¥ä¸€è¿å‘é€10ä¸ªæ¢æµ‹æŠ¥æ–‡ä»ç„¶æ²¡ååº”ï¼ŒæœåŠ¡å™¨å°±è®¤ä¸ºå®¢æˆ·ç«¯å‡ºäº†æ•…éšœï¼Œæ¥ç€å°±å…³é—­è¿æ¥ã€‚

`é—®é¢˜4ï¼š ä¸ºå•¥åªæœ‰ä¸‰æ¬¡æ¡æ‰‹æ‰èƒ½ç¡®è®¤åŒæ–¹çš„æ¥å—ä¸å‘é€èƒ½åŠ›æ˜¯å¦æ­£å¸¸ï¼Œè€Œä¸¤æ¬¡å´ä¸å¯ä»¥ï¼Ÿ`
>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ç½‘ç»œåŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šå®¢æˆ·ç«¯çš„å‘é€èƒ½åŠ›ã€æœåŠ¡ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯æ­£å¸¸çš„
>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯å‘åŒ…ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·å®¢æˆ·ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šæœåŠ¡ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›ï¼Œå®¢æˆ·ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚ä¸è¿‡æ­¤æ—¶æœåŠ¡å™¨å¹¶ä¸èƒ½ç¡®è®¤å®¢æˆ·ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯å¦æ­£å¸¸
>ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ˜¯ä¸ºäº†é˜²æ­¢ï¼šå¦‚æœå®¢æˆ·ç«¯è¿Ÿè¿Ÿæ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨è¿”å›ç¡®è®¤æŠ¥æ–‡ï¼Œè¿™æ—¶ä¼šæ”¾å¼ƒè¿æ¥ï¼Œé‡æ–°å¯åŠ¨ä¸€æ¡è¿æ¥è¯·æ±‚ï¼Œä½†é—®é¢˜æ˜¯ï¼šæœåŠ¡å™¨ä¸çŸ¥é“å®¢æˆ·ç«¯æ²¡æœ‰æ”¶åˆ°ï¼Œæ‰€ä»¥ä»–ä¼šæ”¶åˆ°ä¸¤ä¸ªè¿æ¥ï¼Œæµªè´¹è¿æ¥å¼€é”€ã€‚å¦‚æœæ¯æ¬¡éƒ½æ˜¯è¿™æ ·ï¼Œå°±ä¼šæµªè´¹å¤šä¸ªè¿æ¥å¼€é”€ã€‚

`é—®é¢˜4è¡ç”Ÿé—®é¢˜ï¼šä¸ºä»€ä¹ˆTCPå®¢æˆ·ç«¯æœ€åè¿˜è¦å‘é€ä¸€æ¬¡ç¡®è®¤å‘¢`
>ä¸€å¥è¯ï¼Œä¸»è¦é˜²æ­¢å·²ç»å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡çªç„¶åˆä¼ é€åˆ°äº†æœåŠ¡å™¨ï¼Œä»è€Œäº§ç”Ÿé”™è¯¯ã€‚
>å¦‚æœä½¿ç”¨çš„æ˜¯ä¸¤æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œå‡è®¾æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼Œå®¢æˆ·ç«¯å‘é€äº†ç¬¬ä¸€ä¸ªè¯·æ±‚è¿æ¥å¹¶ä¸”æ²¡æœ‰ä¸¢å¤±ï¼Œåªæ˜¯å› ä¸ºåœ¨ç½‘ç»œç»“ç‚¹ä¸­æ»ç•™çš„æ—¶é—´å¤ªé•¿äº†ï¼Œç”±äºTCPçš„å®¢æˆ·ç«¯è¿Ÿè¿Ÿæ²¡æœ‰æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡ï¼Œä»¥ä¸ºæœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°ï¼Œæ­¤æ—¶é‡æ–°å‘æœåŠ¡å™¨å‘é€è¿™æ¡æŠ¥æ–‡ï¼Œæ­¤åå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç»è¿‡ä¸¤æ¬¡æ¡æ‰‹å®Œæˆè¿æ¥ï¼Œä¼ è¾“æ•°æ®ï¼Œç„¶åå…³é—­è¿æ¥ã€‚æ­¤æ—¶æ­¤å‰æ»ç•™çš„é‚£ä¸€æ¬¡è¯·æ±‚è¿æ¥ï¼Œç½‘ç»œé€šç•…äº†åˆ°è¾¾äº†æœåŠ¡å™¨ï¼Œè¿™ä¸ªæŠ¥æ–‡æœ¬è¯¥æ˜¯å¤±æ•ˆçš„ï¼Œä½†æ˜¯ï¼Œä¸¤æ¬¡æ¡æ‰‹çš„æœºåˆ¶å°†ä¼šè®©å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å†æ¬¡å»ºç«‹è¿æ¥ï¼Œè¿™å°†å¯¼è‡´ä¸å¿…è¦çš„é”™è¯¯å’Œèµ„æºçš„æµªè´¹ã€‚

`é—®é¢˜5ï¼šï¼ˆISNï¼‰æ˜¯å›ºå®šçš„å—`

>ä¸‰æ¬¡æ¡æ‰‹çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº¤æ¢ISN(Initial Sequence Number), ä»¥ä¾¿è®©å¯¹æ–¹çŸ¥é“æ¥ä¸‹æ¥æ¥æ”¶æ•°æ®çš„æ—¶å€™å¦‚ä½•æŒ‰åºåˆ—å·ç»„è£…æ•°æ®ã€‚å¦‚æœISNæ˜¯å›ºå®šçš„ï¼Œæ”»å‡»è€…å¾ˆå®¹æ˜“çŒœå‡ºåç»­çš„ç¡®è®¤å·ï¼Œå› æ­¤ ISN æ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚

`é—®é¢˜6ï¼šä»€ä¹ˆæ˜¯åŠè¿æ¥é˜Ÿåˆ—`

>æœåŠ¡å™¨ç¬¬ä¸€æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯çš„ SYN ä¹‹åï¼Œå°±ä¼šå¤„äº SYN_RCVD çŠ¶æ€ï¼Œæ­¤æ—¶åŒæ–¹è¿˜æ²¡æœ‰å®Œå…¨å»ºç«‹å…¶è¿æ¥ï¼ŒæœåŠ¡å™¨ä¼šæŠŠæ­¤ç§çŠ¶æ€ä¸‹è¯·æ±‚è¿æ¥æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œæˆ‘ä»¬æŠŠè¿™ç§é˜Ÿåˆ—ç§°ä¹‹ä¸ºåŠè¿æ¥é˜Ÿåˆ—ã€‚å½“ç„¶è¿˜æœ‰ä¸€ä¸ªå…¨è¿æ¥é˜Ÿåˆ—ï¼Œå°±æ˜¯å·²ç»å®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹èµ·è¿æ¥çš„å°±ä¼šæ”¾åœ¨å…¨è¿æ¥é˜Ÿåˆ—ä¸­ã€‚

`é—®é¢˜7ï¼šSYN-ACK é‡ä¼ æ¬¡æ•°çš„é—®é¢˜`

>æœåŠ¡å™¨å‘é€å®ŒSYNï¼ACKåŒ…ï¼Œå¦‚æœæœªæ”¶åˆ°å®¢æˆ·ç¡®è®¤åŒ…ï¼ŒæœåŠ¡å™¨è¿›è¡Œé¦–æ¬¡é‡ä¼ ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ä»æœªæ”¶åˆ°å®¢æˆ·ç¡®è®¤åŒ…ï¼Œè¿›è¡Œç¬¬äºŒæ¬¡é‡ä¼ ï¼Œå¦‚æœé‡ä¼ æ¬¡æ•°è¶… è¿‡ç³»ç»Ÿè§„å®šçš„æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼Œç³»ç»Ÿå°†è¯¥è¿æ¥ä¿¡æ¯ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚æ³¨æ„ï¼Œæ¯æ¬¡é‡ä¼ ç­‰å¾…çš„æ—¶é—´ä¸ä¸€å®šç›¸åŒï¼Œä¸€èˆ¬ä¼šæ˜¯æŒ‡æ•°å¢é•¿ï¼Œä¾‹å¦‚é—´éš”æ—¶é—´ä¸º 1s, 2s, 4s, 8s, ....

`é—®é¢˜8ï¼šä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­å¯ä»¥æºå¸¦æ•°æ®å—`

>å¾ˆå¤šäººå¯èƒ½ä¼šè®¤ä¸ºä¸‰æ¬¡æ¡æ‰‹éƒ½ä¸èƒ½æºå¸¦æ•°æ®ï¼Œå…¶å®ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥æºå¸¦æ•°æ®çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡ã€ç¬¬äºŒæ¬¡æ¡æ‰‹ä¸å¯ä»¥æºå¸¦æ•°æ®ï¼Œè€Œç¬¬ä¸‰æ¬¡æ¡æ‰‹æ˜¯å¯ä»¥æºå¸¦æ•°æ®çš„,æ­¤æ—¶å®¢æˆ·ç«¯å·²ç»å¤„äº established çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œä»–å·²ç»å»ºç«‹èµ·è¿æ¥äº†ï¼Œå¹¶ä¸”ä¹Ÿå·²ç»çŸ¥é“æœåŠ¡å™¨çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„äº†ï¼Œæ‰€ä»¥èƒ½æºå¸¦æ•°æ®é¡µæ²¡å•¥æ¯›ç—…

`é—®é¢˜9ï¼šä¸‰æ¬¡æ¡æ‰‹çš„ä½œç”¨`
>ç¡®è®¤åŒæ–¹çš„æ¥å—èƒ½åŠ›ã€å‘é€èƒ½åŠ›æ˜¯å¦æ­£å¸¸;
>æŒ‡å®šè‡ªå·±çš„åˆå§‹åŒ–åºåˆ—å·ï¼Œä¸ºåé¢çš„å¯é ä¼ é€åšå‡†å¤‡ã€‚
>å¦‚æœæ˜¯ https åè®®çš„è¯ï¼Œä¸‰æ¬¡æ¡æ‰‹è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿˜ä¼šè¿›è¡Œæ•°å­—è¯ä¹¦çš„éªŒè¯ä»¥åŠåŠ å¯†å¯†é’¥çš„ç”Ÿæˆåˆ°ã€‚ä¸ºäº†é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µçªç„¶åˆä¼ é€åˆ°äº†æœåŠ¡ç«¯ï¼Œå› è€Œäº§ç”Ÿé”™è¯¯
 
`é—®é¢˜10ï¼šæ¡æ‰‹å¤±è´¥`

>ç¬¬ä¸€æ¬¡æ¡æ‰‹Aå‘é€SYNä¼ è¾“å¤±è´¥ï¼ŒA,Béƒ½ä¸ä¼šç”³è¯·èµ„æºï¼Œè¿æ¥å¤±è´¥ã€‚å¦‚æœä¸€æ®µæ—¶é—´å†…å‘å‡ºå¤šä¸ªSYNè¿æ¥è¯·æ±‚ï¼Œé‚£ä¹ˆAåªä¼šæ¥å—å®ƒæœ€åå‘é€çš„é‚£ä¸ªSYNçš„SYN+ACKå›åº”ï¼Œå¿½ç•¥å…¶ä»–å›åº”å…¨éƒ¨å›åº”ï¼ŒBä¸­å¤šç”³è¯·çš„èµ„æºä¹Ÿä¼šé‡Šæ”¾

>ç¬¬äºŒæ¬¡æ¡æ‰‹Bå‘é€SYN+ACKä¼ è¾“å¤±è´¥ï¼ŒAä¸ä¼šç”³è¯·èµ„æºï¼ŒBç”³è¯·äº†èµ„æºï¼Œä½†æ”¶ä¸åˆ°Açš„ACKï¼Œè¿‡ä¸€æ®µæ—¶é—´é‡Šæ”¾èµ„æºã€‚å‘¨æœŸæ€§é‡ä¼ ï¼Œå¦‚æœæ˜¯æ”¶åˆ°äº†å¤šä¸ªAçš„SYNè¯·æ±‚ï¼ŒBéƒ½ä¼šå›å¤SYN+ACKï¼Œä½†Aåªä¼šæ‰¿è®¤å…¶ä¸­å®ƒæœ€æ—©å‘é€çš„é‚£ä¸ªSYNçš„å›åº”ï¼Œå¹¶å›å¤æœ€åä¸€æ¬¡æ¡æ‰‹çš„ACK

>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ACKä¼ è¾“å¤±è´¥ï¼ŒBæ²¡æœ‰æ”¶åˆ°ACKï¼Œé‡Šæ”¾èµ„æºï¼Œå¯¹äºååºçš„Açš„ä¼ è¾“æ•°æ®è¿”å›RSTã€‚å®é™…ä¸ŠBä¼šå› ä¸ºæ²¡æœ‰æ”¶åˆ°Açš„ACKä¼šå¤šæ¬¡å‘é€SYN+ACKï¼Œæ¬¡æ•°æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œå¦‚æœæœ€åè¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°Açš„ACKï¼Œåˆ™é‡Šæ”¾èµ„æºï¼Œå¯¹Açš„æ•°æ®ä¼ è¾“è¿”å›RST

#### äº”ã€æ”»å‡»è¿‡ç¨‹

`synæº¢å‡ºæ”»å‡»`

>å¦‚æœå®¢æˆ·ç«¯ä¼ªé€ å‡ºå¤§é‡ç¬¬ä¸€æ¬¡çš„sysåŒæ­¥æŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯å°±ä¼šä¾æ¬¡æ¶ˆè€—æ‰å¾ˆå¤šèµ„æºæ¥ä¿å­˜å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œç¡®è®¤ï¼Œå®é™…ä¸Šç¡®è®¤æ˜¯ä¼šå¤±è´¥çš„ï¼Œä½†å¤±è´¥éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œå› ä¸ºæœåŠ¡ç«¯ä¼šè¿ç»­å¤šæ¬¡è¿›è¡Œç¬¬äºŒæ¬¡æ¡æ‰‹ç¡®è®¤åæ‰è®¤å®šå¤±è´¥ã€‚é‚£ä¹ˆçŸ­æ—¶é—´æœ‰å¤§é‡çš„sysåŒæ­¥æŠ¥æ–‡æ¶Œå‘æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯èµ„æºå¯èƒ½è¢«è€—å°½ï¼Œå°±å¯èƒ½å¯¼è‡´æ­£å¸¸çš„å®¢æˆ·ç«¯å¾—ä¸åˆ°å“åº”è€Œå¤±è´¥ã€‚

`é˜²å¾¡æªæ–½ï¼š`

>ç¼©çŸ­SYNTimeoutæ—¶é—´,é™åˆ¶åŒæ—¶æ‰“å¼€çš„SYNåŠè¿æ¥æ•°ç›®
>SYN Floodæ”»å‡»æ•ˆæœå–å†³äºæœåŠ¡å™¨ä¸Šä¿æŒçš„SYNåŠè¿æ¥æ•°ï¼Œè¿™ä¸ªå€¼=SYNæ”»å‡»çš„é¢‘åº¦ x SYN Timeoutï¼Œè®¾ç½®20ç§’ä»¥ä¸‹å¯ä»¥æˆå€çš„é™ä½æœåŠ¡å™¨çš„è´Ÿè·ã€‚

>è®¾ç½®SYN Cookie
åœ¨TCPæœåŠ¡å™¨æ¥æ”¶åˆ°TCP SYNåŒ…å¹¶è¿”å›TCP SYN + ACKåŒ…æ—¶ï¼Œä¸åˆ†é…ä¸€ä¸ªä¸“é—¨çš„æ•°æ®åŒºï¼Œè€Œæ˜¯æ ¹æ®è¿™ä¸ªSYNåŒ…è®¡ç®—å‡ºä¸€ä¸ªcookieå€¼ã€‚è¿™ä¸ªcookieä½œä¸ºå°†è¦è¿”å›çš„SYN ACKåŒ…çš„åˆå§‹åºåˆ—å·ã€‚å½“å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªACKåŒ…æ—¶ï¼Œæ ¹æ®åŒ…å¤´ä¿¡æ¯è®¡ç®—cookieï¼Œä¸è¿”å›çš„ç¡®è®¤åºåˆ—å·(åˆå§‹åºåˆ—å· + 1)è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™æ˜¯ä¸€ä¸ªæ­£å¸¸è¿æ¥ï¼Œç„¶åï¼Œåˆ†é…èµ„æºï¼Œå»ºç«‹è¿æ¥ï¼Œå¦‚æœçŸ­æ—¶é—´å†…è¿ç»­å—åˆ°æŸä¸ªIPçš„é‡å¤SYNæŠ¥æ–‡ï¼Œå°±è®¤å®šæ˜¯å—åˆ°äº†æ”»å‡»ï¼Œä»¥åä»è¿™ä¸ªIPåœ°å€æ¥çš„åŒ…ä¼šè¢«ä¸¢å¼ƒã€‚

>ä¸ºé˜²æ­¢TCPä¼šè¯åŠ«æŒï¼ŒåŠ å¯†ä¼ è¾“

æ¨èçœ‹çœ‹

- [TCPçš„æ¨é€æ¯”ç‰¹PSH(Push)](https://blog.csdn.net/ce123_zhouwei/article/details/9038365)

å‚è€ƒé“¾æ¥ ğŸ”—
- [tcp ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹å‡ å¸¸è§é¢è¯•é¢˜](https://www.cnblogs.com/kingle-study/p/9480689.html)
- [TCPçš„ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ç†è§£åŠé¢è¯•é¢˜](https://blog.csdn.net/qq_38950316/article/details/81087809)
- [TCPåè®®çš„å­¦ä¹ ï¼ˆä¸‰ï¼‰TCPåè®®ä¸‰æ¬¡æ¡æ‰‹åŠæ”»å‡»](https://blog.csdn.net/qq_34501940/article/details/51113965)
